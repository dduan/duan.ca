<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Daniel Duan">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://duan.ca/2017/12/30/hello-world-in-webassembly/">
    <meta property="og:site_name" content="Daniel Duan's Website">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Hello World In WebAssembly">
    <meta property="article:published_time" content="2017-12-30T18:43:49-08:00"><meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@daniel_duan">
    <meta name="twitter:creator" content="@Daniel Duan">
    <meta name="apple-mobile-web-app-title" content="Daniel Duan">
    <title>Hello World In WebAssembly</title>
    <link rel="alternate" type="application/rss+xml" title="Daniel Duan's Website" href="/feed.xml">
    <link rel="canonical" href="https://duan.ca/2017/12/30/hello-world-in-webassembly/">
    <link rel="stylesheet" href="/styles.css"></link>
    <link rel="shortcut icon" href="/favicon.ico">
</head>
<body><article>
    <h1>Hello World In WebAssembly</h1>
    <nav>
        <p class="metainfo article-meta">
            <a href="/articles">Daniel Duan</a>
            ·
            <time datetime="2017-12-30T18:43:49-08:00" itemProp="datePublished">2017-12-30</time>
        </p>
    </nav><p>Every now and then, I check on the progress of Web Assembly. I did it again
around the time of this post and finally found enough tutorials, examples, and
working software to get myself started in this area. In doing so, I made a video
to demo some progress. (<em>this article includes all the same information and
more, so just read on if you don't have 15 minutes for YouTube</em>).</p>
<div class="video-container">
    <iframe src="https://www.youtube.com/embed/yEYtwmI7bDg" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</div>
<br>
<h2>Our goal:</h2>
<ol>
<li>Use as much built-in tools on a Mac as possible. The web development
toolchain scares me.</li>
<li>Target the browser. That's where the value of WebAssembly is. (Node supports
it as well. BUT, WHY THO?)</li>
<li>Build from scratch. In the video I started from <code>mkdir</code> a folder. We should
strive to understand details on every level whenever possible. Boilerplates
and dependencies should come later.</li>
</ol>
<h2>Things you'll need:</h2>
<ol>
<li>Safari 11+</li>
<li>Xcode. More specifically, you should be able to run <code>clang</code> in a shell.</li>
</ol>
<h2>The Workflow</h2>
<p>Having these things installed, get a copy of <a href="https://github.com/WebAssembly/wabt">The WebAssembly Binary
Toolkit</a> (wabt). Build it. The README has detailed instructions. I just went
into the folder and ran</p>
<pre><code>make clang-release
</code></pre>
<p>This will generate a bunch of binary files in <code>out/clang/Release</code> and you need
to make sure you can run them from wherever you want to work on WebAssembly
project (so either copy them into a folder included in your <code>PATH</code> environment
variable or add the absolute path to <code>out/clang/Release</code> to <code>PATH</code>).</p>
<p>Among the binaries &quot;wabt&quot; builds, <code>wat2wasm</code> takes a <code>.wat</code> file and compiles it
to a WebAssembly binary. A <code>.wat</code> is a source file in the <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format">text format</a> for
WebAssembly, which is in the form of S-expressions. So</p>
<pre><code>wat2wasm main.wat -o main.wasm
</code></pre>
<p>…will compile your WebAssembly module in <code>main.wat</code> to generate <code>main.wasm</code>, the
binary file. For now, <code>main.wat</code> can be the simplest WebAssembly program:</p>
<pre><code class="language-lisp">(module)
</code></pre>
<p>Running the binary in a browser demands the bulk of the work. First, we'll need
a web page. It doesn't need any content other than invoking some JavaScript
code.</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;!-- The only thing that matters is the following line,
    although having a valid HTML5 page is nice. --&gt;
    &lt;script src=&quot;play.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>First, the Javascript logic needs to <em>fetch and instantiate the compiled
WebAssembly module</em>. Since this is not a JS or WebAssembly tutorial, I'll point
you to the docmuntation for <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly">the WebAssembly
object</a> for details:</p>
<pre><code class="language-javascript">fetch(&quot;main.wasm&quot;).then(reponse =&gt;
    reponse.arrayBuffer()
).then(bytes =&gt;
    WebAssembly.instantiate(bytes, {})
).then(result =&gt;
    result.instance
).then(main);

</code></pre>
<p>This snippet fetches <code>main.wasm</code> (adjust this URL according to your choosing),
instantiate it, then pass it into a function named <code>main</code>, we can put
a placeholder logic for it for now:</p>
<pre><code class="language-javascript">function main(wasm) {
    console.log(wasm);
}
</code></pre>
<p>Before we move on, you'll find that simply opending your HTML file in browser
and looking at developer console won't work. Safari would complain about
cross-domain request error for <code>fetch</code>. So we need to serve these resources
locally. I usually use the built in server module from Python standard library
for this kind of things:</p>
<pre><code># In your source folder, run
python -m SimpleHTTPServer
</code></pre>
<p>Now go to <a href="http://localhost:8000">http://localhost:8000</a> and click on your HTML file. If everything
went well, you should see a WebAssembly instance logged in the developer
console.</p>
<p>Congratulations! You can start writing WebAssembly locally. Just remember to
re-compile <code>main.wat</code> with <code>wat2wasm</code> whenever you want to test things out in
browser.</p>
<h2>An Actual &quot;Hello, World!&quot; Implementation</h2>
<p>This is my implementation:</p>
<pre><code class="language-lisp">(module
  ;; Allocate a page of linear memory (64kb). Export it as &quot;memory&quot;
  (memory (export &quot;memory&quot;) 1)

  ;; Write the string at the start of the linear memory.
  (data (i32.const 0) &quot;Hello, world!&quot;) ;; write string at location 0

  ;; Export the position and length of the string.
  (global (export &quot;length&quot;) i32 (i32.const 12))
  (global (export &quot;position&quot;) i32 (i32.const 0)))
</code></pre>
<p>In other words, we expose information of the linear memory we manipulated to the
JavaScript environment. Things that has been <code>export</code>ed will show up as
properties of <code>exports</code> of the <code>WebAssembly</code> instance. We can access them in the
<code>main</code> JavaScript functions:</p>
<pre><code class="language-javascript">function main(wasm) {
    const memory   = wasm.exports.memory;
    const length   = wasm.exports.length;
    const position = wasm.exports.position;
    ...
}
</code></pre>
<p>Then it's just plain-old Javascript (tho I had to steal it from tutorials).
<code>memory.buffer</code> is of type <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a>. We need to convert it into a string
and log it to the console:</p>
<pre><code class="language-javascript">function main(wasm) {
    const memory   = wasm.exports.memory;
    const length   = wasm.exports.length;
    const position = wasm.exports.position;

    const bytes = new Uint8Array(memory.buffer, position, length);
    const s = new TextDecoder('utf8').decode(bytes);

    console.log(s);
}
</code></pre>
<p>Et, voilà! <code>Hello, World!</code> hot off a Web Assembly module in your developer
console. To conclude, I personally like to use a <code>Makefile</code> to streamline some
of the typing. Here's what I used for this demo:</p>
<pre><code class="language-makefile">compile:
	wat2wasm main.wat -o main.wasm

serve:
	python -m SimpleHTTPServer
</code></pre>
<h2>Conclusion</h2>
<p>No fancy schmancy Javascript build stack, no 3rd-party code dependency. Write
code, compile, run on your (virtual, in browser) machine, repeat. That sounds like
&quot;assembly&quot; to me!</p>

</article>
<footer>
    <hr />
    <p class="metainfo article-meta">
        <a href="/articles/">More Articles</a>
        ·
        <a href="/tag/webassembly/">WebAssembly</a>
        ·
        <a href="/tag/youtube/">YouTube</a>
    </p>
</footer></body>
</html>