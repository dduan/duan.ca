<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Daniel Duan">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://duan.ca/2022/02/09/building-indexstoredb-on-linux/">
    <meta property="og:site_name" content="Daniel Duan's Website">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Building IndexStoreDB on Linux: The Portable Technique">
    <meta property="article:published_time" content="2022-02-09T15:58:41-08:00"><meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@daniel_duan">
    <meta name="twitter:creator" content="@Daniel Duan">
    <meta name="apple-mobile-web-app-title" content="Daniel Duan">
    <title>Building IndexStoreDB on Linux: The Portable Technique</title>
    <link rel="alternate" type="application/rss+xml" title="Daniel Duan's Website" href="/feed.xml">
    <link rel="canonical" href="https://duan.ca/2022/02/09/building-indexstoredb-on-linux/">
    <link rel="stylesheet" href="/styles.css"></link>
    <link rel="shortcut icon" href="/favicon.ico">
</head>
<body><article>
    <h1>Building IndexStoreDB on Linux: The Portable Technique</h1>
    <nav>
        <p class="metainfo article-meta">
            <a href="/articles">Daniel Duan</a>
            ·
            <time datetime="2022-02-09T15:58:41-08:00" itemProp="datePublished">2022-02-09</time>
        </p>
    </nav><h2>The problem</h2>
<p>As of writing of this article, when you attempt to use Apple's Swift library <a href="https://github.com/apple/indexstore-db">IndexStoreDB</a> on Linux as
a normal SwiftPM dependency, it won't build successfully:</p>
<pre><code class="language-fish">❯ cat Package.resolved
{
  &quot;object&quot;: {
    &quot;pins&quot;: [
      {
        &quot;package&quot;: &quot;IndexStoreDB&quot;,
        &quot;repositoryURL&quot;: &quot;https://github.com/apple/indexstore-db&quot;,
        &quot;state&quot;: {
          &quot;branch&quot;: &quot;swift-5.5.2-RELEASE&quot;,
          &quot;revision&quot;: &quot;e771994778265c2efe8d33a7ca30adf5f3d2065a&quot;,
          &quot;version&quot;: null
        }
      }
    ]
  },
  &quot;version&quot;: 1
}

❯ swift build &gt; /dev/null

❯ echo $status
1
</code></pre>
<p>The issue is documented in the build instruction for Linux:</p>
<blockquote>
<p>The C++ code in the index requires <code>libdispatch</code>, but unlike Swift code, it cannot find it automatically on Linux. You can work around this by adding a search path manually.</p>
</blockquote>
<pre><code>$ swift build -Xcxx -I&lt;path_to_swift_toolchain&gt;/usr/lib/swift -Xcxx -I&lt;path_to_swift_toolchain&gt;/usr/lib/swift/Block
</code></pre>
<p>Okay, so, how would my package build in Linux environments where the Swift toolchain's setup is unknown? How
do we avoid building with one toolchain while mixing in <code>libdispatch</code> from another toolchain somewhere? Here's
what I did for my command-line tool <a href="https://github.com/dduan/Clue">Clue</a>.</p>
<h2>The solution</h2>
<p>The essence of the problem is about the installation location of the Swift toolchain. Our solution makes the
following assumptions:</p>
<ol>
<li>A Swift toolchain is installed on the file system on Linux (duh!).</li>
<li>The toolchain is at least similar to the one distributed on Swift.org. So <code>libdispatch</code> is distributed
alongside the other binaries, in a stable relative directory.</li>
</ol>
<p>Having the <code>swift</code> command available (assumption #1), we can just let it tell us about itself with the
<code>-print-target-info</code> flag:</p>
<pre><code class="language-fish">❯ swift -print-target-info
{
  &quot;compilerVersion&quot;: &quot;Swift version 5.5.2 (swift-5.5.2-RELEASE)&quot;,
  &quot;target&quot;: {
    &quot;triple&quot;: &quot;x86_64-unknown-linux-gnu&quot;,
    &quot;unversionedTriple&quot;: &quot;x86_64-unknown-linux-gnu&quot;,
    &quot;moduleTriple&quot;: &quot;x86_64-unknown-linux-gnu&quot;,
    &quot;compatibilityLibraries&quot;: [ ],
    &quot;librariesRequireRPath&quot;: false
  },
  &quot;paths&quot;: {
    &quot;runtimeLibraryPaths&quot;: [
      &quot;/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift/linux&quot;
    ],
    &quot;runtimeLibraryImportPaths&quot;: [
      &quot;/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift/linux&quot;,
      &quot;/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift/linux/x86_64&quot;
    ],
    &quot;runtimeResourcePath&quot;: &quot;/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift&quot;
  }
}
</code></pre>
<p>Great! We see where the runtime is installed. Now we can invoke assumption #2, that <code>libdispatch</code> is at
a relative location to the rest of the runtime. In the output from above, the value for <code>runtimeResourcePath</code>
happens to be the parent directory for <code>libdispatch</code>'s headers. The <code>&lt;path_to_swift_toolchain&gt;</code> value in
<a href="https://github.com/apple/indexstore-db">IndexStoreDB</a>'s official instruction in this particular setup would be
<code>/home/dan/.swiftenv/versions/5.5.2</code>.  So the following command would have worked:</p>
<pre><code>swift build -Xcxx -I/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift -Xcxx -I/home/dan/.swiftenv/versions/5.5.2/usr/lib/swift/Block
</code></pre>
<p>All we need to do is parse this information at build time, and it should work on every Linux setup! Choose
whatever parsing method you like. Here's (more or less) the <code>Makefile</code> for <a href="https://github.com/dduan/Clue">Clue</a>:</p>
<pre><code class="language-make">SHELL = /bin/bash
ifeq ($(shell uname),Darwin)
EXTRA_SWIFT_FLAGS = &quot;--disable-sandbox&quot;
else
SWIFT_TOOLCHAIN = &quot;$(shell swift -print-target-info | grep runtimeResourcePath | cut -f 2 -d ':' | cut -f 2 -d '&quot;')&quot;
EXTRA_SWIFT_FLAGS = -Xcxx -I${SWIFT_TOOLCHAIN} -Xcxx -I${SWIFT_TOOLCHAIN}/Block
endif

define build
	@swift build --configuration $(1) -Xswiftc -warnings-as-errors ${EXTRA_SWIFT_FLAGS}
endef

.PHONY: build
build:
	$(call build,release)

.PHONY: test
test:
	@swift test ${EXTRA_SWIFT_FLAGS}

.PHONY: debug
debug:
	$(call build,debug)
</code></pre>
<ol>
<li><code>make build</code> / <code>make test</code> / <code>make debug</code> all work as expected, building IndexStoreDB successfully.</li>
<li>As-is, this snippet is project-agnostic. So you can throw it in your SwiftPM project and it should &quot;just
work&quot;.</li>
</ol>
<p>Alright!</p>

</article>
<footer>
    <hr />
    <p class="metainfo article-meta">
        <a href="/articles/">More Articles</a>
        ·
        <a href="/tag/swift/">Swift</a>
        ·
        <a href="/tag/indexstoredb/">IndexStoreDB</a>
        ·
        <a href="/tag/swiftpm/">SwiftPM</a>
    </p>
</footer></body>
</html>