<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daniel Duan</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,600">
  <link rel="stylesheet" href="/style.css">
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Daniel Duan" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Daniel Duan - Daniel Duan thinks.</title>
<meta property="og:title" content="Daniel Duan" />
<meta name="description" content="Daniel Duan thinks." />
<meta property="og:description" content="Daniel Duan thinks." />
<link rel="canonical" href="https://duan.ca/" />
<meta property="og:url" content="https://duan.ca/" />
<meta property="og:site_name" content="Daniel Duan" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@daniel_duan" />
<meta name="twitter:creator" content="@Daniel Duan" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Daniel Duan",
    "headline": "Daniel Duan",
    "description": "Daniel Duan thinks.",
    "url": "https://duan.ca/"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <div class="container">
    <header class="masthead">
  <h1 class="masthead-title">
    <a href="/">Daniel Duan<span>&#39;s blog</span></a>
  </h1>
  <nav class="masthead-nav">
    
    <a href="/articles">articles</a>
    
    <a href="/links">Links</a>
    
    <a href="/projects">Projects</a>
    
    <a href="/about">About</a>
    
  </nav>
</header>
<div class="content page">
  <h3 class="page-title"></h3>
  


  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2017/12/09/list-comprehension-in-swift/">List Comprehension In Swift</a></h1>
    
    <div class="post-date">
      
      <time>09 Dec 2017</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/python">Python</a>,
      
        <a href="/tag/haskell">Haskell</a>
      
      </div>
      
    </div>
    <p>Let‚Äôs explore ways to add list comprehension to Swift.</p>

<h2 id="motivation">Motivation</h2>

<p><a href="https://en.wikipedia.org/wiki/List_comprehension">List comprehension</a> should be no stranger to a Python or (and?) Haskell user. It‚Äôs a really compact syntax
that deals with <a href="https://en.wikipedia.org/wiki/Cartesian_product">Cartesian product</a> of lists. In the case of Python, it‚Äôs probably responsible for the lack
of evolution of lambda expressions, since it‚Äôs much nicer to write one-liners with it in place of <code class="highlighter-rouge">map</code>s and
<code class="highlighter-rouge">filter</code>s.</p>

<p>Here‚Äôs an example of an list comprehension in Haskell from Wikipedia:</p>

<div class="language-haskell highlighter-rouge"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">3</span><span class="o">..</span><span class="mi">5</span><span class="p">]]</span>
<span class="c1">-- [(1,3),(1,4),(1,5),(2,3),(2,4) ...</span>
</code></pre>
</div>

<p>In this example, a list of pair of integers is constructed from 2 lists of integers.</p>

<p>Here is what that example would be in Python:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
<span class="c"># [(1, 3), (1, 4), (1, 5), (2, 3), (2, 4) ...</span>
</code></pre>
</div>

<p>Here‚Äôs what it would be in mathematics (except we are dealing with sets, not lists, but I‚Äôll only refer to
lists from here on.):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Let (a, b) be an ordered list of elements

{(x, y)|x ‚àà {1,2,3,4,5}, y ‚àà {3,4,5}}
</code></pre>
</div>

<p>One can filter out unwanted elements with predicates, and apply arbitrary functions to elements of the
result. Let‚Äôs say we only want even numbers from the first list, and we want the sum of x and y, continuing on
our examples:</p>

<div class="language-haskell highlighter-rouge"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">3</span><span class="o">..</span><span class="mi">5</span><span class="p">],</span> <span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">x+y|x</span><span class="w"> </span><span class="err">‚àà</span><span class="w"> </span><span class="err">{1,2,3,4,5</span><span class="p">}</span><span class="err">,</span><span class="w"> </span><span class="err">y</span><span class="w"> </span><span class="err">‚àà</span><span class="w"> </span><span class="p">{</span><span class="err">3,4,5</span><span class="p">}</span><span class="err">,</span><span class="w"> </span><span class="err">x</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">even}</span><span class="w">
</span></code></pre>
</div>

<p>In theory, this syntax can be applied to an arbitrary number of lists. Putting aside how often this need comes
up in day-to-day programming in your domain, it should be obvious that it‚Äôs alternative, be it nested loops or
<code class="highlighter-rouge">map</code>s and <code class="highlighter-rouge">filter</code>s, is pretty clumsy in comparison.</p>

<h2 id="adding-list-comprehension-in-swift">Adding List Comprehension in Swift</h2>

<p>A comprehension can be considered in 3 parts:</p>

<ol>
  <li>some lists, each may contain a different type of elements.</li>
  <li>a predicate (or a series of them joined logically) to filter out elements.</li>
  <li>a function to process the combination of elements into results.</li>
</ol>

<p>In Swift, if our input is only one list, there‚Äôs a pretty sweet way to achieve that:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">list</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
</code></pre>
</div>

<p>To make comprehension work with more lists, we have some syntax options.</p>

<h3 id="option-one">Option One</h3>

<p>The ‚Äúbrute force‚Äù option would be a function that parameterize all 3 parts of the comprehension. Such as</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// going with order of appearance in Python/Haskell syntax</span>
<span class="kd">func</span> <span class="n">comprehension</span><span class="o">&lt;</span><span class="kt">Element</span><span class="p">,</span> <span class="kt">List</span><span class="p">,</span> <span class="kt">Result</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nv">predicate</span><span class="p">:</span> <span class="p">(</span><span class="kt">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">,</span>
    <span class="nv">list</span><span class="p">:</span> <span class="kt">List</span><span class="p">,</span>
    <span class="nv">processor</span><span class="p">:</span> <span class="p">(</span><span class="kt">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
<span class="p">)</span> <span class="k">where</span>
    <span class="kt">List</span><span class="p">:</span> <span class="kt">Sequence</span><span class="p">,</span> <span class="kt">List</span><span class="o">.</span><span class="kt">Element</span> <span class="o">==</span> <span class="kt">Element</span>

<span class="p">{</span>
    <span class="c1">// implementation</span>
<span class="p">}</span>
</code></pre>
</div>

<p>To supporting more than one list, just add more parameters to both types and the function itself.</p>

<p>(Can‚Äôt wait until we can have <a href="https://github.com/apple/swift/blob/master/docs/GenericsManifesto.md#variadic-generics">variadic generic parameters</a>!)</p>

<h3 id="option-two">Option Two</h3>

<p>Deploy more syntax tricks. Somehow make it visually similar to the math/Haskell/Python notation. If we can
accept some temporary data structure and introduce/implement some operators, there‚Äôd be many possibilities.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">/// Just an example of the infinite possibilities.</span>
<span class="n">processor</span> <span class="o">|</span> <span class="n">list0</span> <span class="o">&amp;&amp;&amp;</span> <span class="n">list1</span> <span class="o">|</span> <span class="n">predicate</span>
</code></pre>
</div>

<p>I‚Äôll leave the implementation of this example as an exercise to the reader.</p>

<h3 id="option-that-i-like">Option That I Like</h3>

<p>I spent quite some time exploring the realm of possibilities in ‚Äúoption two‚Äù. However, introducing data
structures and custom operators just to do what ‚Äúoption one‚Äù offers seems really unappealing. It‚Äôs not
entirely clear that doing so would be ‚ÄúSwift-y‚Äù anyways! Eventually, I did find an arrangement that fits in
Swift, and requires no fancy syntax trickery.</p>

<p>The result of list comprehension is a list. The goal of this operation is to <em>construct</em> a list. Yep, thinking
along this line, it became obvious that using a ‚Äúlist‚Äù‚Äôs initializer is just natural:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">a</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="mi">1</span><span class="o">..&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">..&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">})</span> <span class="p">{</span> <span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="nv">$1</span><span class="p">)</span> <span class="p">}</span>
<span class="c1">// [(2,3),(2,4),(2,5) ...</span>
</code></pre>
</div>

<p>The processing function is at the end to take advantage of the trailing closure syntax. It‚Äôs nicer when
there‚Äôs not predicate:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">a</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="mi">1</span><span class="o">..&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">..&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="nv">$1</span><span class="p">)</span> <span class="p">}</span>
<span class="c1">// [(1,3),(1,4),(1,5),(2,3),(2,4) ...</span>
</code></pre>
</div>

<p>This syntax seems both succinct and Swift-y.</p>

<p>I put an implementation on <a href="https://github.com/dduan/Comprehension">github</a>, in case you find it useful.</p>

<h2 id="parting-thoughts">Parting Thoughts</h2>

<p>There‚Äôs no doubt that the conclusion in this post is imperfect. Though it feels more Swift-y, it deviates from
the mathematical syntax by a lot. We can only implement it for finite number of lists. When many lists are
involved, using a embedded closure as the predicate would make the compiler complain that the expression is
too complex. We suffer from the normal woes with Swift closures where anonymous arguments (<code class="highlighter-rouge">$0</code>, <code class="highlighter-rouge">$1</code>, etc)
won‚Äôt work unless the last one is mentioned in the closure‚Äôs body. Overloading <code class="highlighter-rouge">Array</code> initializer may
negatively affect compilation speed in large projects.</p>

<p>Not all of these issues are temporary.</p>

<p>Does list comprehension warrant a language change in Swift? Can you think of better ways to implement it
with the current compiler?</p>


  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2017/05/22/build-in-swift-compatibility-mode/">Building Swift Projects In Source Compatibility Mode</a></h1>
    
    <div class="post-date">
      
      <time>22 May 2017</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/xcode">Xcode</a>
      
      </div>
      
    </div>
    <p>It‚Äôs a few weeks before WWDC, so naturally¬π it‚Äôs time to try build your Swift
projects in the compiler‚Äôs compatibility mode!</p>

<ol>
  <li>
    <p>Download and install a snapshot for the next major version <a href="https://swift.org/download/">on
Swift.org</a>.</p>

    <p><img src="/assets/2017/05/download-swift-snapshot.png" alt="download swift toolchain" />
 <img src="/assets/2017/05/install-swift-snapshot.png" alt="install swift toolchain" /></p>
  </li>
  <li>
    <p>Choose the newly installed toolchain in Xcode.</p>

    <p><img src="/assets/2017/05/choose-toolchain.png" alt="choose swift toolchain in Xcode" /></p>
  </li>
  <li>
    <p>Ask the compiler to use compatibility mode. This means using the complier
flag <code class="highlighter-rouge">-swift-version X</code>, where ‚ÄúX‚Äù is the <em>current</em> major Swift version.</p>

    <p>In project‚Äôs ‚ÄúBuild Settings‚Äù, value for ‚ÄúOther Swift Flags‚Äù should
 contain <code class="highlighter-rouge">-swift-version X</code>. This could mean setting it in Xcode, in
 <code class="highlighter-rouge">.xcconfig</code> files you are using and/or in your dependency managers such
 as Cocoapods.</p>

    <p><img src="/assets/2017/05/compat-mode-flag.png" alt="compatibility flag in xcode" /></p>

    <p>For example, with Cocoapods, you‚Äôll need to add the following in your
 <code class="highlighter-rouge">Podfile</code> to compile 3rd party libraries in compatibility mode:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> post_install do |installer|
     installer.pods_projects.targets.each do |target|
         target.build_configurations.each do |config|
             config.build_settings["OTHER_SWIFT_FLAGS"] = "$(inherited) -swift-version 3"
         end
     end
 end
</code></pre>
    </div>
  </li>
  <li>
    <p>Build your project! This is where things start to get exciting.</p>

    <p>You should expect some warnings. Hopefully they are self-explanatory
enough. Most of them should correspond to <a href="https://apple.github.io/swift-evolution/">a swift-evolution
proposal</a>.</p>

    <p>Improvement to the language or compiler usually means some of these
warnings tell you problems in your code that has been ignored by the
compiler previously. Fix them today!</p>

    <p>The project should compile successfully in compatibility mode (despite
warnings). This where you can stop reading. Go celebrate with your
coworkers, friends, and family!</p>

    <p>Things could go wrong for compiler snapshots, of course. Read on if see
errors or crashes (whaaaaat üò∏).</p>
  </li>
  <li>
    <p>It‚Äôs time to tell the compiler team about the error or crash you encountered.</p>

    <p>Reduce the error or crash to a state that your are comfortable reporting in
public. Then go to <a href="https://bugs.swift.org">bugs.swift.org</a> and file a JIRA
ticket describing the error or compiler crash.</p>

    <p>During the process of code reduction you may find ways to work around the
compile error or crash. Make the changes for the workaround and repeat
steps 4-5. Maybe your project will compile this time.</p>
  </li>
  <li>
    <p>The issue you discovered will be fixed in the official Swift release come
fall. You‚Äôve ensured a smooth Swift upgrade for your project and contributed
to the Swift community üéâ!</p>
  </li>
</ol>

<hr />

<p>¬π source compatibility mode is a thing starting with Swift 4. As new
major version of Swift is released, code written in the previous version should
compile without change in compatibility mode.</p>

  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2017/02/07/replying-to-old-mailing-list-threads/">Replying To Old Mailing List Threads</a></h1>
    
    <div class="post-date">
      
      <time>07 Feb 2017</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift-evolution">Swift Evolution</a>,
      
        <a href="/tag/email">Email</a>
      
      </div>
      
    </div>
    <p><em>One common complains on the Swift Evolution mailing list is about its
inscrutable interface. If you see an inactive thread on the web archive but
haven‚Äôt subscribed, there seems to be no way to participate or ‚Äúrevive‚Äù it
since you never received any of its emails.</em></p>

<p><em>With a <a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20170206/031537.html">hint</a> and some experiments, I‚Äôve discovered that there is
a way. This post reveals the magic step by step (without commenting on the
merits of email or this solution).</em></p>

<p>Like HTTP, Email is a text-based <a href="https://tools.ietf.org/html/rfc2822">protocol</a>. Unlike HTTP, we directly
consume payloads of this protocol and, as a consequence, don‚Äôt think much about
that very fact.</p>

<p>Like HTTP, each email includes headers hidden by normal email clients. Each
header is essentially two strings, a key and a value, separated by a colon.
Among these headers are <code class="highlighter-rouge">Message-Id</code> and <code class="highlighter-rouge">In-Reply-To</code>. When we tell our email
client applications to start a reply, they take the value from <code class="highlighter-rouge">Message-Id</code>
and use it as value for <code class="highlighter-rouge">In-Reply-To</code> automatically.</p>

<p>To observe all this in action, we can open some emails with our favorite text
editors and look for these headers. Of course, this require us to know where the
emails exist as files. On macOS, an easy thing to do is to drag from Mail.app to
Finder/Desktop and open the resulting .eml file:</p>

<p><img src="https://duan.ca/assets/2017/02/open-email.gif" alt="Open an email in text editors" /></p>

<p>Among the (perhaps overwhelming amount of) headers, we‚Äôll find the two fields we
are looking for:</p>

<p><img src="https://duan.ca/assets/2017/02/email-headers.png" alt="Email Headers Message-Id and
In-Reply-To" /></p>

<p>‚Ä¶ I‚Äôll leave the clients‚Äô reply behavior regarding these fields for the reader
to verify.</p>

<p>Mailing list software such as GNU Mailman, which <a href="https://swift.org">swift.org</a> and <a href="http://llvm.org">llvm.org</a>
use to host various mailing lists, associate emails in threads by chaining them
with the headers explained above, among other things. As long as we have
a message‚Äôs <code class="highlighter-rouge">Message-Id</code>, we can reply to it ‚Äúofficially‚Äù by adding its value to
the <code class="highlighter-rouge">In-Reply-To</code> header in our email, regardless of whether we have received
that email ourselves previously.</p>

<p>So here are the steps to reply retroactively to a mailing list thread.</p>

<ol>
  <li>
    <p><strong>find <code class="highlighter-rouge">Message-Id</code> of the mailing list message we want to reply to.</strong></p>

    <p>This value is contained in the mailing list web archive‚Äôs <code class="highlighter-rouge">mailto</code> link.
Unfortunately Mail.app doesn‚Äôt recognize it. It‚Äôs easy enough to find it
ourselves though:</p>

    <p><img src="https://duan.ca/assets/2017/02/find-message-id.gif" alt="Finding Message-Id on mailman
archive" /></p>

    <p>Note the <code class="highlighter-rouge">&lt;</code>, <code class="highlighter-rouge">&gt;</code>, <code class="highlighter-rouge">@</code> characters are percent-quoted. We have to recover the
id values to the format
<code class="highlighter-rouge">&lt;alphanumerics-potentially-separated-by-dash@address.com&gt;</code>.</p>

    <p>Another way to acquire this value is from the gzip‚Äôd archive. There they
just exist as plain text. The downside is you have to dig out the message
itself first.</p>
  </li>
  <li>
    <p><strong>Add <code class="highlighter-rouge">In-Reply-To</code> header to our email.</strong></p>

    <p>Draft a new email, make its title the same as our email chain‚Äôs title (this
is a good idea because lots of email <em>clients</em> do use the title to thread
messages). Set the appropriate recipients, and CCs, including the mailing
list‚Äôs address. Now save this email as draft and open it in a text editor as
we did in our investigations.  Add in the line
<code class="highlighter-rouge">In-Reply-To: &lt;id-we-found-in-step-one.address.com&gt;</code>, save it. Then send this
email (for example, open it with Mail.app and use Message-&gt;Send Again in the
menu).</p>

    <p>Of course, some email client <a href="http://www.pixelbeat.org/docs/thunderbird-threading.html">supports</a> adding it
from their GUI.</p>
  </li>
</ol>

<p>You‚Äôll find the in addition to functioning as an normal message to the
recipients, the mailing list will properly put your message to the original
thread (in the case of swift-evolution, only if your reply is within the same
week).</p>


  </div>
  <hr />
  


<footer class="masthead">
<h4>Read More:</h4>
<nav class="masthead-nav">
  
  <a href="/articles">articles</a>
  
  <a href="/links">Links</a>
  
  <a href="/projects">Projects</a>
  
  <a href="/about">About</a>
  
</nav>
</footer>

</div>

  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)
    },i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-59501714-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
