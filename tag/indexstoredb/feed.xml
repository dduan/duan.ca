<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>Daniel Duan's Articles About IndexStoreDB</title>
        <link>https://duan.ca/tag/indexstoredb/</link>
        <atom:link href="https://duan.ca/tag/indexstoredb/feed.xml" rel="self" type="application/rss+xml" />
            <item>
                <title>Building IndexStoreDB on Linux: The Portable Technique</title>
                <description>&lt;h2&gt;The problem&lt;&#x2f;h2&gt;
&lt;p&gt;As of writing of this article, when you attempt to use Apple&#x27;s Swift library &lt;a href=&quot;https:&#x2f;&#x2f;github.com&#x2f;apple&#x2f;indexstore-db&quot;&gt;IndexStoreDB&lt;&#x2f;a&gt; on Linux as
a normal SwiftPM dependency, it won&#x27;t build successfully:&lt;&#x2f;p&gt;
&lt;pre&gt;&lt;code class=&quot;language-fish&quot;&gt;❯ cat Package.resolved
{
  &amp;quot;object&amp;quot;: {
    &amp;quot;pins&amp;quot;: [
      {
        &amp;quot;package&amp;quot;: &amp;quot;IndexStoreDB&amp;quot;,
        &amp;quot;repositoryURL&amp;quot;: &amp;quot;https:&#x2f;&#x2f;github.com&#x2f;apple&#x2f;indexstore-db&amp;quot;,
        &amp;quot;state&amp;quot;: {
          &amp;quot;branch&amp;quot;: &amp;quot;swift-5.5.2-RELEASE&amp;quot;,
          &amp;quot;revision&amp;quot;: &amp;quot;e771994778265c2efe8d33a7ca30adf5f3d2065a&amp;quot;,
          &amp;quot;version&amp;quot;: null
        }
      }
    ]
  },
  &amp;quot;version&amp;quot;: 1
}

❯ swift build &amp;gt; &#x2f;dev&#x2f;null

❯ echo $status
1
&lt;&#x2f;code&gt;&lt;&#x2f;pre&gt;
&lt;p&gt;The issue is documented in the build instruction for Linux:&lt;&#x2f;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The C++ code in the index requires &lt;code&gt;libdispatch&lt;&#x2f;code&gt;, but unlike Swift code, it cannot find it automatically on Linux. You can work around this by adding a search path manually.&lt;&#x2f;p&gt;
&lt;&#x2f;blockquote&gt;
&lt;pre&gt;&lt;code&gt;$ swift build -Xcxx -I&amp;lt;path_to_swift_toolchain&amp;gt;&#x2f;usr&#x2f;lib&#x2f;swift -Xcxx -I&amp;lt;path_to_swift_toolchain&amp;gt;&#x2f;usr&#x2f;lib&#x2f;swift&#x2f;Block
&lt;&#x2f;code&gt;&lt;&#x2f;pre&gt;
&lt;p&gt;Okay, so, how would my package build in Linux environments where the Swift toolchain&#x27;s setup is unknown? How
do we avoid building with one toolchain while mixing in &lt;code&gt;libdispatch&lt;&#x2f;code&gt; from another toolchain somewhere? Here&#x27;s
what I did for my command-line tool &lt;a href=&quot;https:&#x2f;&#x2f;github.com&#x2f;dduan&#x2f;Clue&quot;&gt;Clue&lt;&#x2f;a&gt;.&lt;&#x2f;p&gt;
&lt;h2&gt;The solution&lt;&#x2f;h2&gt;
&lt;p&gt;The essence of the problem is about the installation location of the Swift toolchain. Our solution makes the
following assumptions:&lt;&#x2f;p&gt;
&lt;ol&gt;
&lt;li&gt;A Swift toolchain is installed on the file system on Linux (duh!).&lt;&#x2f;li&gt;
&lt;li&gt;The toolchain is at least similar to the one distributed on Swift.org. So &lt;code&gt;libdispatch&lt;&#x2f;code&gt; is distributed
alongside the other binaries, in a stable relative directory.&lt;&#x2f;li&gt;
&lt;&#x2f;ol&gt;
&lt;p&gt;Having the &lt;code&gt;swift&lt;&#x2f;code&gt; command available (assumption #1), we can just let it tell us about itself with the
&lt;code&gt;-print-target-info&lt;&#x2f;code&gt; flag:&lt;&#x2f;p&gt;
&lt;pre&gt;&lt;code class=&quot;language-fish&quot;&gt;❯ swift -print-target-info
{
  &amp;quot;compilerVersion&amp;quot;: &amp;quot;Swift version 5.5.2 (swift-5.5.2-RELEASE)&amp;quot;,
  &amp;quot;target&amp;quot;: {
    &amp;quot;triple&amp;quot;: &amp;quot;x86_64-unknown-linux-gnu&amp;quot;,
    &amp;quot;unversionedTriple&amp;quot;: &amp;quot;x86_64-unknown-linux-gnu&amp;quot;,
    &amp;quot;moduleTriple&amp;quot;: &amp;quot;x86_64-unknown-linux-gnu&amp;quot;,
    &amp;quot;compatibilityLibraries&amp;quot;: [ ],
    &amp;quot;librariesRequireRPath&amp;quot;: false
  },
  &amp;quot;paths&amp;quot;: {
    &amp;quot;runtimeLibraryPaths&amp;quot;: [
      &amp;quot;&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift&#x2f;linux&amp;quot;
    ],
    &amp;quot;runtimeLibraryImportPaths&amp;quot;: [
      &amp;quot;&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift&#x2f;linux&amp;quot;,
      &amp;quot;&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift&#x2f;linux&#x2f;x86_64&amp;quot;
    ],
    &amp;quot;runtimeResourcePath&amp;quot;: &amp;quot;&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift&amp;quot;
  }
}
&lt;&#x2f;code&gt;&lt;&#x2f;pre&gt;
&lt;p&gt;Great! We see where the runtime is installed. Now we can invoke assumption #2, that &lt;code&gt;libdispatch&lt;&#x2f;code&gt; is at
a relative location to the rest of the runtime. In the output from above, the value for &lt;code&gt;runtimeResourcePath&lt;&#x2f;code&gt;
happens to be the parent directory for &lt;code&gt;libdispatch&lt;&#x2f;code&gt;&#x27;s headers. The &lt;code&gt;&amp;lt;path_to_swift_toolchain&amp;gt;&lt;&#x2f;code&gt; value in
&lt;a href=&quot;https:&#x2f;&#x2f;github.com&#x2f;apple&#x2f;indexstore-db&quot;&gt;IndexStoreDB&lt;&#x2f;a&gt;&#x27;s official instruction in this particular setup would be
&lt;code&gt;&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&lt;&#x2f;code&gt;.  So the following command would have worked:&lt;&#x2f;p&gt;
&lt;pre&gt;&lt;code&gt;swift build -Xcxx -I&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift -Xcxx -I&#x2f;home&#x2f;dan&#x2f;.swiftenv&#x2f;versions&#x2f;5.5.2&#x2f;usr&#x2f;lib&#x2f;swift&#x2f;Block
&lt;&#x2f;code&gt;&lt;&#x2f;pre&gt;
&lt;p&gt;All we need to do is parse this information at build time, and it should work on every Linux setup! Choose
whatever parsing method you like. Here&#x27;s (more or less) the &lt;code&gt;Makefile&lt;&#x2f;code&gt; for &lt;a href=&quot;https:&#x2f;&#x2f;github.com&#x2f;dduan&#x2f;Clue&quot;&gt;Clue&lt;&#x2f;a&gt;:&lt;&#x2f;p&gt;
&lt;pre&gt;&lt;code class=&quot;language-make&quot;&gt;SHELL = &#x2f;bin&#x2f;bash
ifeq ($(shell uname),Darwin)
EXTRA_SWIFT_FLAGS = &amp;quot;--disable-sandbox&amp;quot;
else
SWIFT_TOOLCHAIN = &amp;quot;$(shell swift -print-target-info | grep runtimeResourcePath | cut -f 2 -d &#x27;:&#x27; | cut -f 2 -d &#x27;&amp;quot;&#x27;)&amp;quot;
EXTRA_SWIFT_FLAGS = -Xcxx -I${SWIFT_TOOLCHAIN} -Xcxx -I${SWIFT_TOOLCHAIN}&#x2f;Block
endif

define build
	@swift build --configuration $(1) -Xswiftc -warnings-as-errors ${EXTRA_SWIFT_FLAGS}
endef

.PHONY: build
build:
	$(call build,release)

.PHONY: test
test:
	@swift test ${EXTRA_SWIFT_FLAGS}

.PHONY: debug
debug:
	$(call build,debug)
&lt;&#x2f;code&gt;&lt;&#x2f;pre&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;make build&lt;&#x2f;code&gt; &#x2f; &lt;code&gt;make test&lt;&#x2f;code&gt; &#x2f; &lt;code&gt;make debug&lt;&#x2f;code&gt; all work as expected, building IndexStoreDB successfully.&lt;&#x2f;li&gt;
&lt;li&gt;As-is, this snippet is project-agnostic. So you can throw it in your SwiftPM project and it should &amp;quot;just
work&amp;quot;.&lt;&#x2f;li&gt;
&lt;&#x2f;ol&gt;
&lt;p&gt;Alright!&lt;&#x2f;p&gt;
</description>
                <pubDate>Wed, 09 Feb 2022 15:58:41 -0800</pubDate>
                <link>https://duan.ca/2022/02/09/building-indexstoredb-on-linux/</link>
                <guid isPermaLink="true">https://duan.ca/2022/02/09/building-indexstoredb-on-linux/</guid>
            </item>
    </channel>
</rss>